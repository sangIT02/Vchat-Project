<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Th√¥ng b√°o</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
  </head>
  <body class="p-4">
    <h4><i class="bi bi-bell-fill text-primary"></i> Th√¥ng b√°o</h4>
    <hr />

    <div id="notificationList" class="mt-3"></div>

    <button
      class="btn btn-outline-primary mt-4"
      onclick="requestNotificationHistory(currentPage + 1, 10)"
    >
      T·∫£i th√™m
    </button>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      const token = localStorage.getItem("accessToken"); // üëà Ch·ªânh l·∫°i n·∫øu b·∫°n l∆∞u token ch·ªó kh√°c
      let stompClient = null;
      let currentPage = 0;

      function connectSocket() {
        const socket = new SockJS("http://localhost:8080/ws"); // üëà Thay ƒë√∫ng path BE
        stompClient = Stomp.over(socket);

        stompClient.connect(
          { Authorization: "Bearer " + token },
          () => {
            console.log("‚úÖ K·∫øt n·ªëi WebSocket");

            stompClient.subscribe(
              "/user/queue/notification.history",
              (message) => {
                const pageData = JSON.parse(message.body);
                renderNotifications(pageData.content || []);
                currentPage = pageData.number;
              }
            );

            requestNotificationHistory(0, 10);
          },
          (err) => {
            console.error("‚ùå L·ªói k·∫øt n·ªëi:", err);
          }
        );
      }

      function requestNotificationHistory(page, size) {
        const payload = { page: page, size: size };
        stompClient.send(
          "/app/notification.history",
          {},
          JSON.stringify(payload)
        );
      }

      function renderNotifications(list) {
        const container = document.getElementById("notificationList");

        if (list.length === 0 && currentPage === 0) {
          container.innerHTML = `<div class="text-muted text-center">üì≠ Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>`;
          return;
        }

        list.forEach((noti) => {
          const div = document.createElement("div");
          div.className =
            "alert alert-light border shadow-sm d-flex align-items-start gap-3 mb-3";

          const createdAt = new Date(noti.createAt).toLocaleString("vi-VN");

          div.innerHTML = `
      <img src="${noti.profileUrl || "../images/default-avatar.jpg"}" 
           class="rounded-circle mt-1" 
           style="width: 40px; height: 40px; object-fit: cover;" />

      <div>
        <div>${noti.content}</div>
        <small class="text-muted">${createdAt}</small>
      </div>
    `;

          container.appendChild(div);
        });
      }

      window.onload = connectSocket;
    </script>
  </body>
</html>
