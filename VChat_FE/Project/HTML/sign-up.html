<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đăng ký tài khoản | VChat</title>
  <link rel="icon" type="image/png" href="../images/logo.png" />

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <style>
    :root {
      --brand-1: #6a11cb;
      --brand-2: #2575fc;
      --text-1: #0f172a;
      --muted: #64748b;
      --glass: rgba(255, 255, 255, 0.16);
      --glass-border: rgba(255, 255, 255, 0.35);
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI,
        Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text-1);
      background: radial-gradient(1200px 800px at 10% -10%,
          #c3d3ff 0%,
          transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, #ffd6e7 0%, transparent 50%),
        linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      background-attachment: fixed;
      display: grid;
      place-items: center;
      overflow-x: hidden;
    }

    /* Floating blobs */
    .blob {
      position: absolute;
      filter: blur(50px);
      opacity: 0.55;
      z-index: 0;
    }

    .blob-1 {
      width: 380px;
      height: 380px;
      border-radius: 50%;
      background: #fff;
      top: 6%;
      left: 8%;
      animation: float 12s ease-in-out infinite;
    }

    .blob-2 {
      width: 460px;
      height: 460px;
      border-radius: 50%;
      background: #e0f2fe;
      bottom: -6%;
      right: -4%;
      animation: float 14s ease-in-out infinite reverse;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-18px);
      }
    }

    /* Shell */
    .page-wrap {
      position: relative;
      z-index: 1;
      width: min(1080px, 92vw);
    }

    .card-glass {
      background: linear-gradient(180deg,
          rgba(255, 255, 255, 0.7),
          rgba(255, 255, 255, 0.55));
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(16, 24, 40, 0.2);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .hero-col {
      background: radial-gradient(600px 400px at 30% 20%,
          rgba(255, 255, 255, 0.35) 0%,
          transparent 60%),
        linear-gradient(160deg,
          rgba(255, 255, 255, 0.35),
          rgba(255, 255, 255, 0.05));
      padding: clamp(28px, 5vw, 44px);
    }

    .brand-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 999px;
      font-weight: 600;
    }

    .brand-badge i {
      color: var(--brand-2);
    }

    .hero-title {
      font-weight: 800;
      line-height: 1.12;
      letter-spacing: -0.02em;
      font-size: clamp(24px, 3.4vw, 36px);
    }

    .hero-sub {
      color: var(--muted);
      font-size: clamp(14px, 1.6vw, 16px);
    }

    .form-col {
      padding: clamp(24px, 4.2vw, 40px);
      background: rgba(255, 255, 255, 0.85);
    }

    .input-icon {
      position: absolute;
      inset-inline-start: 12px;
      inset-block-start: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }

    .form-control.ps-5 {
      padding-left: 2.75rem !important;
    }

    .form-control,
    .form-select {
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--brand-2);
      box-shadow: 0 0 0 0.2rem rgba(37, 117, 252, 0.15);
    }

    .btn-gradient {
      background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
      border: none;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .btn-gradient:hover {
      filter: brightness(0.96);
      transform: translateY(-1px);
    }

    .btn-gradient:active {
      transform: translateY(0);
    }

    .divider {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      color: #64748b;
    }

    .divider::before,
    .divider::after {
      content: "";
      height: 1px;
      background: #e2e8f0;
    }

    /* Interest tags */
    .interest-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #eef2ff;
      color: var(--brand-2);
      border-radius: 999px;
      font-weight: 600;
      margin: 4px;
      font-size: 0.92rem;
    }

    .interest-tag button {
      border: 0;
      background: transparent;
      line-height: 0;
      opacity: 0.7;
    }

    .interest-tag button:hover {
      opacity: 1;
    }

    /* Password strength */
    .strength {
      height: 8px;
      border-radius: 999px;
      background: #e2e8f0;
      overflow: hidden;
    }

    .strength>span {
      display: block;
      height: 100%;
      width: 0;
      transition: width 0.3s ease;
    }

    /* Toast */
    .toast-container {
      z-index: 1080;
    }

    /* Small util */
    .hint {
      color: #64748b;
      font-size: 0.9rem;
    }

    .small-link {
      color: var(--brand-2);
      text-decoration: none;
      font-weight: 600;
    }

    .small-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 992px) {
      .hero-col {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <div class="page-wrap">
    <div class="card card-glass">
      <div class="row g-0">
        <!-- Left / Hero -->
        <div class="col-lg-5 hero-col d-flex flex-column justify-content-between">
          <div>
            <span class="brand-badge"><i class="bi bi-heart-fill"></i> VChat</span>
            <h1 class="hero-title mt-3">
              Tạo tài khoản mới
              <span class="d-block" style="color: var(--brand-2)">Kết nối & chia sẻ ngay hôm nay</span>
            </h1>
            <p class="hero-sub mt-3">
              Gia nhập cộng đồng của chúng tôi để đăng bài, tạo tin 24h, chat
              realtime và khám phá bạn bè xung quanh.
            </p>
          </div>
          <ul class="list-unstyled mt-4 mb-0 small text-secondary">
            <li class="mb-2">
              <i class="bi bi-check2-circle me-2"></i>Miễn phí & bảo mật dữ
              liệu
            </li>
            <li class="mb-2">
              <i class="bi bi-check2-circle me-2"></i>Đăng ký nhanh trong 1
              phút
            </li>
            <li>
              <i class="bi bi-check2-circle me-2"></i>Hỗ trợ đăng nhập xã hội
              (sắp có)
            </li>
          </ul>
        </div>

        <!-- Right / Form -->
        <div class="col-lg-7 form-col">
          <form id="signupForm" autocomplete="off" novalidate>
            <div id="error" class="mb-3"></div>

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold" for="fullName">Họ và tên</label>
                <div class="position-relative">
                  <i class="bi bi-person input-icon"></i>
                  <input type="text" class="form-control ps-5" id="fullName" placeholder="Nguyễn Văn A" required
                    minlength="2" maxlength="50" />
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold" for="email">Email</label>
                <div class="position-relative">
                  <i class="bi bi-envelope input-icon"></i>
                  <input type="email" class="form-control ps-5" id="email" placeholder="ban@domain.com" required />
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold" for="password">Mật khẩu</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lock"></i></span>
                  <input type="password" class="form-control" id="password" placeholder="Tối thiểu 8 ký tự" required
                    minlength="8" />
                  <button type="button" class="btn btn-outline-secondary" id="togglePassword" tabindex="-1"
                    aria-label="Ẩn/hiện mật khẩu">
                    <i class="bi bi-eye" id="eyeIcon"></i>
                  </button>
                </div>
                <div class="strength mt-2" aria-hidden="true">
                  <span id="strengthBar"></span>
                </div>
                <div class="hint mt-1" id="strengthHint">
                  Độ mạnh mật khẩu
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold" for="passwordConfirm">Nhập lại mật khẩu</label>
                <div class="position-relative">
                  <i class="bi bi-shield-check input-icon"></i>
                  <input type="password" class="form-control ps-5" id="passwordConfirm" placeholder="Nhập lại mật khẩu"
                    required minlength="8" />
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold" for="birthDate">Ngày sinh</label>
                <input type="date" class="form-control" id="birthDate" required />
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold" for="phoneNumber">Số điện thoại</label>
                <div class="position-relative">
                  <i class="bi bi-telephone input-icon"></i>
                  <input type="text" class="form-control ps-5" id="phoneNumber" placeholder="VD: 0912 345 678" />
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold" for="location">Địa chỉ</label>
                <div class="position-relative">
                  <i class="bi bi-geo-alt input-icon"></i>
                  <input type="text" class="form-control ps-5" id="location"
                    placeholder="Số nhà, đường, phường/xã, tỉnh/thành" maxlength="255" />
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold" for="description">Giới thiệu bản thân</label>
                <textarea class="form-control" id="description" rows="2" maxlength="500"
                  placeholder="Tóm tắt ngắn về bạn"></textarea>
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Sở thích</label>
                <div id="interestTagContainer" class="d-flex flex-wrap gap-2 mb-2">
                  <span class="text-muted">Đang tải danh sách...</span>
                </div>
                <style>
                  .interest-btn {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 7px 16px;
                    background: #eef2ff;
                    color: #2575fc;
                    border-radius: 999px;
                    font-weight: 600;
                    border: 1.5px solid #e2e8f0;
                    cursor: pointer;
                    transition: background 0.18s, color 0.18s, border 0.18s;
                  }

                  .interest-btn.selected {
                    background: linear-gradient(90deg, #6a11cb, #2575fc);
                    color: #fff;
                    border: 1.5px solid #2575fc;
                  }
                </style>
                <script>
                  document.addEventListener('DOMContentLoaded', async function () {
                    // Lấy danh sách sở thích từ API
                    try {
                      const res = await fetch('http://localhost:8080/api/interests-name');
                      const json = await res.json();
                      const container = document.getElementById('interestTagContainer');
                      if (json.success && Array.isArray(json.data)) {
                        container.innerHTML = '';
                        json.data.forEach(name => {
                          const btn = document.createElement('button');
                          btn.type = 'button';
                          btn.className = 'interest-btn';
                          btn.textContent = name;
                          btn.onclick = function () {
                            btn.classList.toggle('selected');
                          };
                          container.appendChild(btn);
                        });
                      } else {
                        container.innerHTML = '<span class="text-danger">Không tải được danh sách!</span>';
                      }
                    } catch (err) {
                      const container = document.getElementById('interestTagContainer');
                      container.innerHTML = '<span class="text-danger">Lỗi tải danh sách!</span>';
                    }
                  });
                </script>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Giới tính</label>
                <select class="form-select" id="gender" required>
                  <option value="">Chọn giới tính</option>
                  <option value="MALE">Nam</option>
                  <option value="FEMALE">Nữ</option>
                  <option value="OTHER">Khác</option>
                </select>
              </div>

              <div class="col-md-6 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="agree" />
                  <label class="form-check-label" for="agree">Tôi đồng ý với
                    <a href="#" class="small-link">Điều khoản</a> &
                    <a href="#" class="small-link">Chính sách</a></label>
                </div>
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-gradient w-100 py-3" id="submitBtn">
                  <span class="me-2" id="btnIcon"><i class="bi bi-person-plus"></i></span>Đăng ký
                </button>
              </div>

              <div class="col-12 text-center mt-2">
                <span class="hint">Đã có tài khoản?</span>
                <a href="login.html" class="small-link ms-1">Đăng nhập</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed top-0 end-0 p-3 toast-container">
    <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Đăng ký thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Helpers =====
    const qs = (s) => document.querySelector(s);
    const byId = (id) => document.getElementById(id);

    // Password toggle
    const passwordInput = byId("password");
    const togglePassword = byId("togglePassword");
    const eyeIcon = byId("eyeIcon");
    togglePassword.addEventListener("click", () => {
      const type = passwordInput.type === "password" ? "text" : "password";
      passwordInput.type = type;
      eyeIcon.className =
        type === "password" ? "bi bi-eye" : "bi bi-eye-slash";
    });

    // Password strength meter
    const strengthBar = byId("strengthBar");
    const strengthHint = byId("strengthHint");
    const setStrength = (score) => {
      const pct = [0, 25, 50, 75, 100][score];
      strengthBar.style.width = pct + "%";
      const colors = ["#e2e8f0", "#fca5a5", "#fdba74", "#fde047", "#4ade80"];
      strengthBar.style.background = colors[score];
      const label = ["Rất yếu", "Yếu", "Trung bình", "Khá", "Mạnh"];
      strengthHint.textContent = "Độ mạnh mật khẩu: " + label[score];
    };
    passwordInput.addEventListener("input", () => {
      const v = passwordInput.value;
      let score = 0;
      if (v.length >= 8) score++;
      if (/[A-Z]/.test(v)) score++;
      if (/[0-9]/.test(v)) score++;
      if (/[^A-Za-z0-9]/.test(v)) score++;
      if (v.length >= 12) score++;
      score = Math.min(score, 4); // map to 0..4
      setStrength(score);
    });


    // Date max today
    const bd = byId("birthDate");
    bd.max = new Date().toISOString().split("T")[0];

    // Submit
    byId("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const err = byId("error");
      err.className = "";
      err.textContent = "";

      const fullName = byId("fullName").value.trim();
      const email = byId("email").value.trim();
      const password = byId("password").value;
      const passwordConfirm = byId("passwordConfirm").value;
      const birthDate = byId("birthDate").value;
      const location = byId("location").value.trim();
      const description = byId("description").value.trim();
      const phoneNumber = byId("phoneNumber").value.trim();
      const gender = byId("gender").value;
      const agree = byId("agree").checked;

      // FE validations
      const showError = (msg) => {
        err.className = "alert alert-danger";
        err.textContent = msg;
      };
      if (!fullName || fullName.length < 2 || fullName.length > 50)
        return showError("Họ tên phải từ 2 đến 50 ký tự.");
      if (!email || !/^([^\s@]+)@([^\s@]+)\.[^\s@]+$/.test(email))
        return showError("Email không hợp lệ.");
      if (!password || password.length < 8)
        return showError("Mật khẩu phải từ 8 ký tự trở lên.");
      if (password !== passwordConfirm)
        return showError("Mật khẩu xác nhận không khớp.");
      if (!birthDate) return showError("Vui lòng chọn ngày sinh.");
      // Lấy sở thích từ các nút đã chọn
      const interests = Array.from(document.querySelectorAll('.interest-btn.selected')).map(btn => btn.textContent);
      if (interests.length === 0)
        return showError("Vui lòng chọn ít nhất một sở thích.");
      if (!gender) return showError("Vui lòng chọn giới tính.");
      if (phoneNumber && !/^(\+?\d{1,3}[- ]?)?\d{9,15}$/.test(phoneNumber))
        return showError("Số điện thoại không hợp lệ.");
      if (!agree) return showError("Bạn cần đồng ý Điều khoản & Chính sách.");

      // Loading state
      const btn = byId("submitBtn");
      const btnIcon = byId("btnIcon");
      btn.disabled = true;
      btn.classList.add("opacity-75");
      btnIcon.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

      try {
        const res = await fetch("http://localhost:8080/api/auth/sign-up", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fullName,
            email,
            password,
            passwordConfirm,
            birthDate,
            location,
            description,
            interestName: interests,
            phoneNumber,
            gender,
            roleName: "USER",
            accountStatus: "ACTIVE",
          }),
        });

        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          data = {
            success: false,
            message: "Không đọc được phản hồi từ server.",
          };
        }

        if (res.ok && data.success) {
          // Success toast
          const toastEl = byId("toast");
          byId("toastMsg").textContent =
            "Đăng ký thành công! Đang chuyển hướng...";
          const toast = new bootstrap.Toast(toastEl, { delay: 1000 });
          toast.show();
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1200);
        } else {
          throw new Error(data.message || "Đăng ký thất bại.");
        }
      } catch (error) {
        err.className = "alert alert-danger";
        err.textContent =
          error.message || "Có lỗi xảy ra khi kết nối tới server.";
      } finally {
        btn.disabled = false;
        btn.classList.remove("opacity-75");
        btnIcon.innerHTML = '<i class="bi bi-person-plus"></i>';
      }
    });
  </script>
</body>

</html>